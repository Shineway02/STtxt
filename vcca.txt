getvccadate:--getvccadate 檢查日期	
	declare @vccano nvarchar(max) = [1]	
	declare @tmpa table(datea nvarchar(max))
	declare @binvono nvarchar(20) = ''
	declare @einvono nvarchar(20) = ''
	declare @datea nvarchar(20) = ''
	select @binvono=binvono,@einvono=einvono from vccars where @vccano between binvono and einvono
	select @datea=MAX(datea) from vcca where noa between @binvono and @einvono and noa<@vccano
	insert into @tmpa(datea)values(isnull(@datea,''))
	select * from @tmpa
	;

batchvcca_rb:--batchvcca_rb
	declare @t_ordeno nvarchar(50) = [1]
	declare @t_total nvarchar(50) = [2]
	declare @t_money nvarchar(50) = [3]
	declare @t_buyerno nvarchar(MAX) = case when '#non'=[4] then '' else [4] end 
	declare @t_buyer nvarchar(MAX) = case when '#non'=[5] then '' else [5] end 
	declare @t_serial nvarchar(MAX) = case when '#non'=[6] then '' else [6] end 
	declare @t_vccano nvarchar(50) = case when '#non'=[7] then '' else [7] end 
	declare @t_woker nvarchar(50) = case when '#non'=[8] then '' else [8] end 
	declare @t_err nvarchar(200)=''
	declare @t_datea nvarchar(20)=''
	declare @t_mon nvarchar(20)=''
	declare @t_vccarno nvarchar(20)
	declare @t_vccno nvarchar(50)
	declare @t_vccaccy nvarchar(50)
	declare @x_vccano nvarchar(MAX)
	--------------------------------------------------------------------------------------------------------
	SET QUOTED_IDENTIFIER OFF
	declare @t_vccacount int,@vccacount int
	set @t_vccacount= cast(@t_total as int)/cast(@t_money as int)
	set @vccacount= cast(@t_total as int)/cast(@t_money as int)
	set @t_vccno=isnull((select vccno from view_orde where noa=@t_ordeno ),'')
	set @t_vccaccy=isnull((select accy from view_vcc where noa=@t_vccno),'')
	
	--現在日期
	if(len(@t_datea)=0)
	begin
		set @t_datea=CONVERT (VARCHAR(7), GETDATE(),12 )+0890000
		set @t_datea=left(@t_datea,3)+'/'+substring(@t_datea,4,2)+'/'+right(@t_datea,2)
	end
	set @t_mon=left(@t_datea,3)+'/'+substring(@t_datea,5,2)
		
	--批次開立的發票號碼
	declare @vcca table(
		recno int identity(1,1),
		vccano nvarchar(20)
	)
	
	--可開立發票
	declare @cvcca table(
		noa nvarchar(20),
		vccano nvarchar(20)
	)

	if(@t_vccano!='') --檢查是否被使用或不存在vcca
	begin
		if((select count(*) from vcca where noa=@t_vccano)>0)
		begin
			set @t_err='發票號碼已存在'
		end
		
		if((select count(*) from vccars where @t_vccano between binvono and einvono)=0)
		begin
			set @t_err='發票號碼不存在發票主檔內'
		end
	end

	declare @vccarno nvarchar(20)
	declare @bvccano nvarchar(20)
	declare @evccano nvarchar(20)
	declare @xvccano nvarchar(20)
	
	if(len(@t_err)=0)
	begin
		--抓取可開立的發票
		declare cursor_table cursor for
		select a.noa,b.binvono,b.einvono from vccar a left join vccars b on a.noa=b.noa where (@t_datea between a.bdate and a.edate) and isnull(a.iselectric,0)=1 order by a.noa,a.binvono
		open cursor_table
		fetch next from cursor_table
		into @vccarno,@bvccano,@evccano
		while(@@FETCH_STATUS <> -1)
		begin
			set @xvccano=@bvccano
			while (@xvccano<=@evccano and (@xvccano between @bvccano and @evccano))
			begin
				if((select count(*) from vcca where noa=@xvccano)=0)
				begin
					insert @cvcca
					select @vccarno,@xvccano
				end
				set @xvccano=LEFT(@xvccano,2)
				+RIGHT('00000000'+cast(cast(RIGHT(@xvccano,8) as int)+1 as nvarchar(10)),8)
			end

			fetch next from cursor_table
			into @vccarno,@bvccano,@evccano
		end
		close cursor_table
		deallocate cursor_table
	
		if((select count(*) from @cvcca)=0) 
		begin
			set @t_err='當期無可用發票'
		end
		else if((select count(*) from @cvcca)<@vccacount) 
		begin
			set @t_err='當期發票不足開立'+CAST(@vccacount as nvarchar(10))+'張發票'
		end
	end
	
	if(len(@t_err)=0)
	begin
		set @t_err='vccaok'
		
		insert @vcca
		select TOP (@vccacount) vccano from @cvcca 
		where vccano>=@t_vccano order by vccano
		
		--不足發票數量
		if((select count(*) from @vcca)<@vccacount)
		begin
			--先刪除 已要寫入的發票
			delete a 
			from @cvcca a
			where exists (select * from @vcca where a.vccano=vccano )
			
			set @vccacount=@vccacount-(select count(*) from @vcca)
			
			insert @vcca
			select TOP (@vccacount) vccano from @cvcca 
			order by noa,vccano
		
		end
		
		insert vcca(noa,custno,comp,nick,serial,buyerno,buyer,datea,mon,cno,acomp,zip,address,taxtype,money,tax,total,trdno,worker,vccno,[type],chkno)
		select a.vccano,b.custno,b.comp,b.nick--,@t_serial,@t_buyerno,@t_buyer
		,dbo.split(@t_serial,'^^',recno-1)
		,dbo.split(@t_buyerno,'^^',recno-1)
		,dbo.split(@t_buyer,'^^',recno-1)
		,@t_datea,case when isnull(b.mon,'')!='' then b.mon else @t_mon end
		,case when isnull(b.cno,'')!='' then b.cno else (select top 1 noa from acomp order by noa) end
		,case when isnull(b.cno,'')!='' then b.acomp else (select top 1 acomp from acomp order by noa) end
		,case when isnull((select top 1 zip_invo from cust where noa=dbo.split(@t_buyerno,'^^',recno-1)),'')!='' then 
		isnull((select top 1 addr_invo from cust where noa=dbo.split(@t_buyerno,'^^',recno-1)),'')
		else isnull((select top 1 zip_invo from cust where noa=b.custno),'') end
		,case when isnull((select top 1 addr_invo from cust where noa=dbo.split(@t_buyerno,'^^',recno-1)),'')!='' then 
		isnull((select top 1 addr_invo from cust where noa=dbo.split(@t_buyerno,'^^',recno-1)),'')
		else isnull((select top 1 addr_invo from cust where noa=b.custno),'') end
		,b.taxtype
		,b.money/@t_vccacount
		,b.tax/@t_vccacount
		,b.total/@t_vccacount
		,@t_ordeno,@t_woker,@t_vccno,'A'
		,right('000000'+cast(cast(cast(
			cast(LOG((ascii(SUBSTRING(a.vccano,1,1))*100)+
			(ascii(SUBSTRING(a.vccano,2,1))*25)+
			cast(SUBSTRING(a.vccano,3,3) as int))*100 as int)
		*144 as int)
		+(SIN(cast(SUBSTRING(a.vccano,6,2) as int))*cast(SUBSTRING(a.vccano,8,3) as int)*100) as int)as nvarchar(10)),6)
		from @vcca a outer apply (select * from view_orde where noa=@t_ordeno) b
		
		insert vccas(noa,noq,custno,productno,product,unit,mount,price,money,datea,ordeno,no2)
		select b.vccano,a.no2,a.custno,a.productno,a.product,a.unit,1
		,round(a.total/@t_vccacount,0),round(a.total/@t_vccacount,0),@t_datea,a.noa,a.no2
		from view_ordes a , @vcca b where a.noa=@t_ordeno
		
		--set @x_vccano=stuff((select ','+vccano from @vcca for xml path('')),1,1,'') 
		set @x_vccano=isnull(stuff((select ','+noa from vcca where trdno=@t_ordeno FOR XML PATH('')),1,1,''),'')
		
		exec("update vcc"+@t_vccaccy+" set invono='"+@x_vccano+"' where noa='"+@t_vccno+"'")
		
		--寫入到orde
		set @t_vccaccy=isnull((select accy from view_orde where noa=@t_ordeno),'')
		exec("update orde"+@t_vccaccy+" set ordbno='"+@x_vccano+"' where noa='"+@t_ordeno+"'")  
		
	end
	
	select @t_err err
;
--************************************************************************************
changeorde_rb:--changeorde_rb
	declare @vccano nvarchar(max) = [1]	
	--------------------------------------------------------------------------------------------------------
	SET QUOTED_IDENTIFIER OFF
	declare @typea nvarchar(max)=isnull((select [type] from vcca where noa=@vccano),'')
	declare @taxtype nvarchar(max)=isnull((select taxtype from vcca where noa=@vccano),'')
	declare @ordeno nvarchar(max)=isnull((select trdno from vcca where noa=@vccano),'')
	declare @accy nvarchar(max)=isnull((select accy from view_orde where noa=@ordeno),'')
	declare @kind nvarchar(max)=isnull((select kind from view_orde where noa=@ordeno),'')
	
	if(@typea='E' and @taxtype='6' and  (select count(*) from view_orde where noa=@ordeno and charindex(@vccano,ordbno)>0 )>0 )
	begin
		exec("update orde"+@accy+" set kind='作廢' where noa='"+@ordeno+"' ")
	end
;